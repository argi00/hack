// Prisma schema - ISM Incubateur
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                   String                 @id @default(cuid())
  email                String                 @unique
  passwordHash         String
  firstName            String
  lastName             String
  phone                String
  role                 String                 @default("USER") // USER | COACH | ADMIN
  isActive             Boolean                @default(true)
  hasProject           Boolean                @default(false)
  projectDescription   String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  gameProgress         GameProgress[]
  projects             Project[]
  hackathonRegistrations HackathonRegistration[]
  coach                Coach?
  feedbacks            Feedback[]
  gameProgressFeedbacks GameProgressFeedback[]
  savedResources       SavedResource[]
  
  @@index([role])
  @@index([isActive])
}

model Project {
  id              String           @id @default(cuid())
  userId          String
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String
  status          String           // "pre-incubation" | "incubation"
  description     String?
  coaches         CoachProject[]
  feedbacks       Feedback[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  @@index([userId])
  @@index([status])
}

model Hackathon {
  id          String                 @id @default(cuid())
  title       String
  slug        String                 @unique
  dateStart   DateTime
  dateEnd     DateTime
  description String
  prize       String?
  places      String?
  status      String                 // "ouvert" | "bientôt" | "terminé"
  image       String?
  featured    Boolean                @default(false)
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  registrations HackathonRegistration[]
}

model HackathonRegistration {
  id         String    @id @default(cuid())
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  hackathonId String
  hackathon  Hackathon @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  createdAt  DateTime  @default(now())
  @@unique([userId, hackathonId])
}

model GameProgress {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectName    String
  currentPhase   Int      @default(1)
  currentQuestion Int     @default(0)
  phaseScores    String   // JSON: {"1": 150, "2": 140, ...}
  answers        String   // JSON: {"1_phase1_problem": "opt1", ...}
  projectContent String?  // JSON: {"phase1_problem": "...", "phase1_solution": "..."}
  oneSentence    String?  // Résumé du projet en une phrase
  totalScore     Int      @default(0)
  maturityScore  Int      @default(0) // Score de maturité en %
  isComplete     Boolean  @default(false)
  lastPlayedAt   DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  feedbacks      GameProgressFeedback[]

  @@index([userId])
}

model Coach {
  id                 String          @id @default(cuid())
  userId             String          @unique
  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignedProjects   CoachProject[]
  feedbacks          Feedback[]
  gameProgressFeedbacks GameProgressFeedback[]
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
}

model CoachProject {
  id                 String          @id @default(cuid())
  coachId            String
  coach              Coach           @relation(fields: [coachId], references: [id], onDelete: Cascade)
  projectId          String
  project            Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignedAt         DateTime        @default(now())
  
  @@unique([coachId, projectId])
  @@index([coachId])
  @@index([projectId])
}

model Feedback {
  id                 String          @id @default(cuid())
  coachId            String
  coach              Coach           @relation(fields: [coachId], references: [id], onDelete: Cascade)
  projectId          String
  project            Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId             String
  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  category           String          // PRODUIT | MARCHE | BUSINESS | EQUIPE | AUTRE
  priority           String          // BASSE | MOYENNE | HAUTE
  content            String
  isRead             Boolean         @default(false)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  
  @@index([coachId])
  @@index([projectId])
  @@index([userId])
}

model GameProgressFeedback {
  id                 String          @id @default(cuid())
  coachId            String
  coach              Coach           @relation(fields: [coachId], references: [id], onDelete: Cascade)
  gameProgressId     String
  gameProgress       GameProgress    @relation(fields: [gameProgressId], references: [id], onDelete: Cascade)
  userId             String
  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  category           String          // PRODUIT | MARCHE | BUSINESS | EQUIPE | AUTRE
  priority           String          // BASSE | MOYENNE | HAUTE
  content            String
  isRead             Boolean         @default(false)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  
  @@index([coachId])
  @@index([gameProgressId])
  @@index([userId])
}

model Resource {
  id              String            @id @default(cuid())
  title           String            @unique
  description     String
  content         String
  category        String            // Guides | Lancement | Business | Pitch | Finance | Metriques | Marketing | Outils
  difficulty      String            // Debutant | Intermediaire | Avance
  duration        Int               // En minutes
  imageUrl        String?
  videoUrl        String?
  externalUrl     String?           // URL externe si c'est un lien
  author          String
  source          String?           // D'où vient la ressource
  status          String            @default("draft") // draft ou published
  tags            String            // JSON array stringified
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  savedBy         SavedResource[]
  relatedFrom     RelatedResource[] @relation("from")
  relatedTo       RelatedResource[] @relation("to")
  
  @@index([category])
  @@index([difficulty])
  @@index([status])
}

model SavedResource {
  id          String    @id @default(cuid())
  userId      String
  resourceId  String
  savedAt     DateTime  @default(now())
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource    Resource  @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  
  @@unique([userId, resourceId])
  @@index([userId])
}

model RelatedResource {
  id              String    @id @default(cuid())
  fromResourceId  String
  toResourceId    String
  
  fromResource    Resource  @relation("from", fields: [fromResourceId], references: [id], onDelete: Cascade)
  toResource      Resource  @relation("to", fields: [toResourceId], references: [id], onDelete: Cascade)
  
  @@unique([fromResourceId, toResourceId])
}
